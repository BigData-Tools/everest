
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>everest.representers.base &mdash; everest 1.0 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/bootstrap.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/bootstrap.js"></script>
    <link rel="top" title="everest 1.0 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" />
<script type="text/javascript">
(function () {
  /**
   * Patch TOC list.
   *
   * Will mutate the underlying span to have a correct ul for nav.
   *
   * @param $span: Span containing nested UL's to mutate.
   * @param minLevel: Starting level for nested lists. (1: global, 2: local).
   */
  var patchToc = function ($ul, minLevel) {
    var findA;

    // Find all a "internal" tags, traversing recursively.
    findA = function ($elem, level) {
      var level = level || 0,
        $items = $elem.find("> li > a.internal, > ul, > li > ul");

      // Iterate everything in order.
      $items.each(function (index, item) {
        var $item = $(item),
          tag = item.tagName.toLowerCase(),
          pad = 15 + ((level - minLevel) * 10);

        if (tag === 'a' && level >= minLevel) {
          // Add to existing padding.
          $item.css('padding-left', pad + "px");
          console.log(level, $item, 'padding-left', pad + "px");
        } else if (tag === 'ul') {
          // Recurse.
          findA($item, level + 1);
        }
      });
    };

    console.log("HERE");
    findA($ul);
  };

  $(document).ready(function () {
    // Add styling, structure to TOC's.
    $(".dropdown-menu").each(function () {
      $(this).find("ul").each(function (index, item){
        var $item = $(item);
        $item.addClass('unstyled');
      });
      $(this).find("li").each(function () {
        $(this).parent().append(this);
      });
    });

    // Patch in level.
    patchToc($("ul.globaltoc"), 2);
    patchToc($("ul.localtoc"), 2);

    // Enable dropdown.
    $('.dropdown-toggle').dropdown();
  });
}());
</script>

  </head>
  <body>
  <div id="navbar" class="navbar navbar-fixed-top">
    <div class="navbar-inner">
      <div class="container-fluid">
        <a class="brand" href="../../../index.html">everest</a>
        <span class="navbar-text pull-left"><b>1.0</b></span>
          <ul class="nav">
            <li class="divider-vertical"></li>
            
              <li class="dropdown">
  <a href="../../../index.html" class="dropdown-toggle" data-toggle="dropdown">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API Reference</a></li>
</ul>
</ul>
</li>
              <li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"></ul>
  <!--<span class="localtoc"></span>-->
</li>
            
            
              
            
            
              
            
          </ul>
          
            
<form class="navbar-search pull-right" style="margin-bottom:-3px;" action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
          </ul>
        </div>
      </div>
    </div>
  </div>

<div class="container">
   
  <h1>Source code for everest.representers.base</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Representer base classes.</span>

<span class="sd">This file is part of the everest project.</span>
<span class="sd">See LICENSE.txt for licensing, CONTRIBUTORS.txt for contributor information.</span>

<span class="sd">Created on May 18, 2011.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">StringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">from</span> <span class="nn">everest.representers.interfaces</span> <span class="kn">import</span> <span class="n">ICollectionDataElement</span>
<span class="kn">from</span> <span class="nn">everest.representers.interfaces</span> <span class="kn">import</span> <span class="n">ILinkedDataElement</span>
<span class="kn">from</span> <span class="nn">everest.representers.interfaces</span> <span class="kn">import</span> <span class="n">IResourceDataElement</span>
<span class="kn">from</span> <span class="nn">everest.representers.utils</span> <span class="kn">import</span> <span class="n">get_mapping_registry</span>
<span class="kn">from</span> <span class="nn">everest.resources.base</span> <span class="kn">import</span> <span class="n">Resource</span>
<span class="kn">from</span> <span class="nn">zope.interface</span> <span class="kn">import</span> <span class="n">providedBy</span> <span class="k">as</span> <span class="n">provided_by</span> <span class="c"># pylint: disable=E0611,F0401</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">__docformat__</span> <span class="o">=</span> <span class="s">&#39;reStructuredText en&#39;</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;RepresentationGenerator&#39;</span><span class="p">,</span>
           <span class="s">&#39;RepresentationParser&#39;</span><span class="p">,</span>
           <span class="s">&#39;Representer&#39;</span><span class="p">,</span>
           <span class="s">&#39;RepresenterRegistry&#39;</span><span class="p">,</span>
           <span class="s">&#39;ResourceRepresenter&#39;</span><span class="p">,</span>
           <span class="s">&#39;data_element_tree_to_string&#39;</span><span class="p">,</span>
           <span class="p">]</span>


<div class="viewcode-block" id="Representer"><a class="viewcode-back" href="../../../api/everest.representers.base.html#everest.representers.base.Representer">[docs]</a><span class="k">class</span> <span class="nc">Representer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for all representers.</span>

<span class="sd">    A representer knows how to convert an object into a representation of a</span>
<span class="sd">    particular MIME type (content type) and vice versa.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">content_type</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">from_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string_representation</span><span class="p">):</span>
        <span class="n">stream</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">string_representation</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_stream</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="n">stream</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">to_stream</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stream</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">from_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;Abstract method.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;Abstract method.&quot;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="ResourceRepresenter"><a class="viewcode-back" href="../../../api/everest.representers.base.html#everest.representers.base.ResourceRepresenter">[docs]</a><span class="k">class</span> <span class="nc">ResourceRepresenter</span><span class="p">(</span><span class="n">Representer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for resource representers which know how to convert resource</span>
<span class="sd">    representations into resources and back.</span>

<span class="sd">    This conversion is performed using four customizable, independent helper</span>
<span class="sd">    objects:</span>
<span class="sd">    </span>
<span class="sd">     1. The *representation parser* responsible for converting the</span>
<span class="sd">        representation into a data element tree;</span>
<span class="sd">     2. The *data element parser* responsible for converting a data element</span>
<span class="sd">        tree into a resource;</span>
<span class="sd">     3. The *data element generator* responsible for converting a resource</span>
<span class="sd">        into a data element tree; and</span>
<span class="sd">     4. the *representation generator* responsible for converting the data</span>
<span class="sd">        element tree into a representation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_class</span><span class="p">,</span> <span class="n">mapping</span><span class="p">):</span>
        <span class="n">Representer</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_class</span> <span class="o">=</span> <span class="n">resource_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span> <span class="o">=</span> <span class="n">mapping</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create_from_resource</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">rc</span><span class="p">):</span>
        <span class="n">mp_reg</span> <span class="o">=</span> <span class="n">get_mapping_registry</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">content_type</span><span class="p">)</span>
        <span class="n">rc_cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">rc</span><span class="p">)</span>
        <span class="n">mp</span> <span class="o">=</span> <span class="n">mp_reg</span><span class="o">.</span><span class="n">find_or_create_mapping</span><span class="p">(</span><span class="n">rc_cls</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">rc_cls</span><span class="p">,</span> <span class="n">mp</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">make_mapping_registry</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;Abstract method.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">from_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_representation_parser</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_class</span><span class="p">,</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="p">)</span>
        <span class="n">data_el</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_from_data</span><span class="p">(</span><span class="n">data_el</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
        <span class="n">data_el</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_from_resource</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
        <span class="n">generator</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_make_representation_generator</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_class</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">generator</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">data_el</span><span class="p">)</span>

<div class="viewcode-block" id="ResourceRepresenter.data_from_stream"><a class="viewcode-back" href="../../../api/everest.representers.base.html#everest.representers.base.ResourceRepresenter.data_from_stream">[docs]</a>    <span class="k">def</span> <span class="nf">data_from_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a data element reading a representation from the given stream.</span>
<span class="sd">        </span>
<span class="sd">        :returns: object implementing </span>
<span class="sd">            :class:`everest.representers.interfaces.IExplicitDataElement`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_representation_parser</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_class</span><span class="p">,</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ResourceRepresenter.data_from_representation"><a class="viewcode-back" href="../../../api/everest.representers.base.html#everest.representers.base.ResourceRepresenter.data_from_representation">[docs]</a>    <span class="k">def</span> <span class="nf">data_from_representation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">representation</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a data element from the given representation.</span>
<span class="sd">        </span>
<span class="sd">        :returns: object implementing </span>
<span class="sd">            :class:`everest.representers.interfaces.IExplicitDataElement`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stream</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">representation</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_from_stream</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ResourceRepresenter.representation_from_data"><a class="viewcode-back" href="../../../api/everest.representers.base.html#everest.representers.base.ResourceRepresenter.representation_from_data">[docs]</a>    <span class="k">def</span> <span class="nf">representation_from_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_element</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a representation from the given data element.</span>
<span class="sd">        </span>
<span class="sd">        :param data_element: </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stream</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">generator</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_make_representation_generator</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_class</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="p">)</span>
        <span class="n">generator</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">data_element</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stream</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ResourceRepresenter.resource_from_data"><a class="viewcode-back" href="../../../api/everest.representers.base.html#everest.representers.base.ResourceRepresenter.resource_from_data">[docs]</a>    <span class="k">def</span> <span class="nf">resource_from_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_element</span><span class="p">,</span> <span class="n">resolve_urls</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts serialized data from the given data element and constructs</span>
<span class="sd">        a resource from it.</span>

<span class="sd">        :param resolve_urls: If this is set to `False`, resolving URLs in the</span>
<span class="sd">          data element tree will be delayed until after loading has completed.</span>
<span class="sd">        :returns: object implementing</span>
<span class="sd">          :class:`everest.resources.interfaces.IResource`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">map_to_resource</span><span class="p">(</span><span class="n">data_element</span><span class="p">,</span>
                                             <span class="n">resolve_urls</span><span class="o">=</span><span class="n">resolve_urls</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ResourceRepresenter.data_from_resource"><a class="viewcode-back" href="../../../api/everest.representers.base.html#everest.representers.base.ResourceRepresenter.data_from_resource">[docs]</a>    <span class="k">def</span> <span class="nf">data_from_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts managed attributes from a resource and constructs a data</span>
<span class="sd">        element for serialization from it.</span>

<span class="sd">        Default representer behavior:</span>
<span class="sd">         * Top-level member and collections resource attributes are</span>
<span class="sd">           represented as links.</span>
<span class="sd">         * Nested member resource attributes are represented as links,</span>
<span class="sd">           nested collection resource attributes are ignored (building a link</span>
<span class="sd">           may require iterating over the collection).</span>

<span class="sd">        The default behavior can be configured with the &quot;representer&quot;</span>
<span class="sd">        directive (:func:`everest.configuration.representer`) by means of the</span>
<span class="sd">        &quot;write_as_link&quot; and &quot;ignore&quot; options of representer configuration</span>
<span class="sd">        objects (:class:`everest.representers.config.RepresenterConfiguration`).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">map_to_data_element</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ResourceRepresenter.configure"><a class="viewcode-back" href="../../../api/everest.representers.base.html#everest.representers.base.ResourceRepresenter.configure">[docs]</a>    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">attribute_options</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configures the attribute mapping for this representer.</span>
<span class="sd">        </span>
<span class="sd">        :param dict options: configuration options for the mapping associated</span>
<span class="sd">          with this representer.</span>
<span class="sd">        :param dict attribute_options: attribute options for the mapping</span>
<span class="sd">          associated with this representer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
                                    <span class="n">attribute_options</span><span class="o">=</span><span class="n">attribute_options</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_make_representation_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">resource_class</span><span class="p">,</span> <span class="n">mapping</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a representation parser from the given arguments. This parser</span>
<span class="sd">        has a `run` method which reads and parses the serialized resource from</span>
<span class="sd">        the given stream.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;Abstract method.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_representation_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">resource_class</span><span class="p">,</span> <span class="n">mapping</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a representation generator from the given arguments. This</span>
<span class="sd">        generator has a `run` method which writes out the serialized</span>
<span class="sd">        resource representation to the given stream.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;Abstract method.&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="RepresenterRegistry"><a class="viewcode-back" href="../../../api/everest.representers.base.html#everest.representers.base.RepresenterRegistry">[docs]</a><span class="k">class</span> <span class="nc">RepresenterRegistry</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Registry for representer classes and representer factories.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__rpr_classes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__mp_regs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__rpr_factories</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">register_representer_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">representer_class</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">representer_class</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rpr_classes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;The representer class &quot;</span><span class="si">%s</span><span class="s">&quot; has already been &#39;</span>
                             <span class="s">&#39;registered.&#39;</span> <span class="o">%</span> <span class="n">representer_class</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__rpr_classes</span><span class="p">[</span><span class="n">representer_class</span><span class="o">.</span><span class="n">content_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">representer_class</span>
        <span class="c"># Create and hold a mapping registry for the registered resource </span>
        <span class="c"># representer class.</span>
        <span class="n">mp_reg</span> <span class="o">=</span> <span class="n">representer_class</span><span class="o">.</span><span class="n">make_mapping_registry</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__mp_regs</span><span class="p">[</span><span class="n">representer_class</span><span class="o">.</span><span class="n">content_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">mp_reg</span>

    <span class="k">def</span> <span class="nf">is_registered_representer_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">representer_class</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">representer_class</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rpr_classes</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_mapping_registry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content_type</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mp_regs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">content_type</span><span class="p">)</span>

<div class="viewcode-block" id="RepresenterRegistry.register"><a class="viewcode-back" href="../../../api/everest.representers.base.html#everest.representers.base.RepresenterRegistry.register">[docs]</a>    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_class</span><span class="p">,</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">configuration</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Registers a representer factory for the given combination of resource</span>
<span class="sd">        class and content type.</span>
<span class="sd">        </span>
<span class="sd">        :param configuration: representer configuration. A default instance</span>
<span class="sd">          will be created if this is not given.</span>
<span class="sd">        :type configuration: </span>
<span class="sd">            :class:`everest.representers.config.RepresenterConfiguration`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">resource_class</span><span class="p">,</span> <span class="n">Resource</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Representers can only be registered for &#39;</span>
                             <span class="s">&#39;resource classes (got: </span><span class="si">%s</span><span class="s">).&#39;</span> <span class="o">%</span> <span class="n">resource_class</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">content_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rpr_classes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;No representer class has been registered for &#39;</span>
                             <span class="s">&#39;content type &quot;</span><span class="si">%s</span><span class="s">&quot;.&#39;</span> <span class="o">%</span> <span class="n">content_type</span><span class="p">)</span>
        <span class="c"># Create or update a mapping.</span>
        <span class="n">mp_reg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mp_regs</span><span class="p">[</span><span class="n">content_type</span><span class="p">]</span>
        <span class="n">mp</span> <span class="o">=</span> <span class="n">mp_reg</span><span class="o">.</span><span class="n">find_mapping</span><span class="p">(</span><span class="n">resource_class</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mp</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># No mapping was registered yet for this resource class or any</span>
            <span class="c"># of its base classes; create a new one on the fly.</span>
            <span class="n">new_mp</span> <span class="o">=</span> <span class="n">mp_reg</span><span class="o">.</span><span class="n">create_mapping</span><span class="p">(</span><span class="n">resource_class</span><span class="p">,</span> <span class="n">configuration</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">configuration</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">resource_class</span> <span class="ow">is</span> <span class="n">mp</span><span class="o">.</span><span class="n">mapped_class</span><span class="p">:</span>
                <span class="c"># We have additional configuration for an existing mapping. </span>
                <span class="n">mp</span><span class="o">.</span><span class="n">configuration</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">configuration</span><span class="p">)</span>
                <span class="n">new_mp</span> <span class="o">=</span> <span class="n">mp</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># We have a derived class with additional configuration.</span>
                <span class="n">new_mp</span> <span class="o">=</span> <span class="n">mp_reg</span><span class="o">.</span><span class="n">create_mapping</span><span class="p">(</span><span class="n">resource_class</span><span class="p">,</span>
                                               <span class="n">configuration</span><span class="o">=</span><span class="n">mp</span><span class="o">.</span><span class="n">configuration</span><span class="p">)</span>
                <span class="n">new_mp</span><span class="o">.</span><span class="n">configuration</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">configuration</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">resource_class</span> <span class="ow">is</span> <span class="n">mp</span><span class="o">.</span><span class="n">mapped_class</span><span class="p">:</span>
            <span class="c"># We have a derived class without additional configuration.</span>
            <span class="n">new_mp</span> <span class="o">=</span> <span class="n">mp_reg</span><span class="o">.</span><span class="n">create_mapping</span><span class="p">(</span><span class="n">resource_class</span><span class="p">,</span>
                                           <span class="n">configuration</span><span class="o">=</span><span class="n">mp</span><span class="o">.</span><span class="n">configuration</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># We found a dynamically created mapping for the right class</span>
            <span class="c"># without additional configuration; do not create a new one.</span>
            <span class="n">new_mp</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">new_mp</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># Store the new (or updated) mapping.</span>
            <span class="n">mp_reg</span><span class="o">.</span><span class="n">set_mapping</span><span class="p">(</span><span class="n">new_mp</span><span class="p">)</span>
        <span class="c"># Register factory resource -&gt; representer for the given resource</span>
        <span class="c"># class, content type combination.</span>
        <span class="n">rpr_cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rpr_classes</span><span class="p">[</span><span class="n">content_type</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__rpr_factories</span><span class="p">[(</span><span class="n">resource_class</span><span class="p">,</span> <span class="n">content_type</span><span class="p">)]</span> <span class="o">=</span> \
                                            <span class="n">rpr_cls</span><span class="o">.</span><span class="n">create_from_resource</span>
</div>
<div class="viewcode-block" id="RepresenterRegistry.create"><a class="viewcode-back" href="../../../api/everest.representers.base.html#everest.representers.base.RepresenterRegistry.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">content_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a representer for the given combination of resource and </span>
<span class="sd">        content type. This will also find representer factories that were</span>
<span class="sd">        registered for a base class of the given resource.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rc_cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">base_rc_cls</span> <span class="ow">in</span> <span class="n">rc_cls</span><span class="o">.</span><span class="n">__mro__</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">rpr_fac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rpr_factories</span><span class="p">[(</span><span class="n">base_rc_cls</span><span class="p">,</span> <span class="n">content_type</span><span class="p">)]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">rpr</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rpr</span> <span class="o">=</span> <span class="n">rpr_fac</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">rpr</span>

</div></div>
<span class="k">class</span> <span class="nc">_RepresentationHandler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for objects handling a representation stream.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">resource_class</span><span class="p">,</span> <span class="n">mapping</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span> <span class="o">=</span> <span class="n">stream</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resource_class</span> <span class="o">=</span> <span class="n">resource_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span> <span class="o">=</span> <span class="n">mapping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__config</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">get_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__config</span><span class="p">[</span><span class="n">option</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">RepresentationParser</span><span class="p">(</span><span class="n">_RepresentationHandler</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: The data element tree parsed from the handled stream.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;Abstract method.&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">RepresentationGenerator</span><span class="p">(</span><span class="n">_RepresentationHandler</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_element</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param data_element: The data element tree to be serialized.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;Abstract method.&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="data_element_tree_to_string"><a class="viewcode-back" href="../../../api/everest.representers.base.html#everest.representers.base.data_element_tree_to_string">[docs]</a><span class="k">def</span> <span class="nf">data_element_tree_to_string</span><span class="p">(</span><span class="n">data_element</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a string representation of the given data element tree.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># FIXME: rewrite this as a visitor to use the data element tree traverser.</span>
    <span class="k">def</span> <span class="nf">__dump</span><span class="p">(</span><span class="n">data_el</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">data_el</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39; &#39;</span> <span class="o">*</span> <span class="n">offset</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
        <span class="n">offset</span> <span class="o">+=</span> <span class="mi">2</span>
        <span class="n">ifcs</span> <span class="o">=</span> <span class="n">provided_by</span><span class="p">(</span><span class="n">data_el</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ICollectionDataElement</span> <span class="ow">in</span> <span class="n">ifcs</span><span class="p">:</span>
            <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;[&quot;</span><span class="p">)</span>
            <span class="n">first_member</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">for</span> <span class="n">member_data_el</span> <span class="ow">in</span> <span class="n">data_el</span><span class="o">.</span><span class="n">get_members</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">first_member</span><span class="p">:</span>
                    <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span> <span class="o">+</span> <span class="s">&#39; &#39;</span> <span class="o">*</span> <span class="n">offset</span><span class="p">)</span>
                    <span class="n">first_member</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;,</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span> <span class="o">+</span> <span class="s">&#39; &#39;</span> <span class="o">*</span> <span class="n">offset</span><span class="p">)</span>
                <span class="n">__dump</span><span class="p">(</span><span class="n">member_data_el</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
            <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;]&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;(&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ILinkedDataElement</span> <span class="ow">in</span> <span class="n">ifcs</span><span class="p">:</span>
                <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;url=</span><span class="si">%s</span><span class="s">, kind=</span><span class="si">%s</span><span class="s">, relation=</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="n">data_el</span><span class="o">.</span><span class="n">get_url</span><span class="p">(),</span> <span class="n">data_el</span><span class="o">.</span><span class="n">get_kind</span><span class="p">(),</span>
                              <span class="n">data_el</span><span class="o">.</span><span class="n">get_relation</span><span class="p">()))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">first_attr</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">for</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">attr_value</span> <span class="ow">in</span> <span class="n">data_el</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">first_attr</span><span class="p">:</span>
                        <span class="n">first_attr</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;,</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span>
                                     <span class="o">+</span> <span class="s">&#39; &#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">attr_value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">IResourceDataElement</span> <span class="ow">in</span> <span class="n">provided_by</span><span class="p">(</span><span class="n">attr_value</span><span class="p">):</span>
                        <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">=</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attr_name</span><span class="p">,</span> <span class="n">attr_value</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">__dump</span><span class="p">(</span><span class="n">attr_value</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
            <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;)&#39;</span><span class="p">)</span>
    <span class="n">stream</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
    <span class="n">__dump</span><span class="p">(</span><span class="n">data_element</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">stream</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span></div>
</pre></div>

</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right"><a href="#">Back to top</a></p>
    <p>
        &copy; Copyright Copyright (c) 2011-2012 F. Oliver Gathmann, Cenix BioScience, Dresden, Germany .<br/>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.<br/>
    </p>
  </div>
</footer>
  </body>
</html>